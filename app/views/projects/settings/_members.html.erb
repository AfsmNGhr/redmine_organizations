<% roles = Role.find_all_givable -%>

<div class="box">

<div class="contextual">
  <%= toggle_link l(:button_add), 'organization-form', {:focus => 'membership_organization_id'} %>
</div>

<h3><%= l(:label_organization_plural) %></h3>

<%= form_for :membership, :url => { :controller => 'organization_memberships', :action => 'create_in_project', :project_id => @project },
             :remote => true, :html => {:id => 'organization-form', :style => 'display:none;'} do |f| -%>
  <p>
    <%= hidden_field_tag "membership[project_id]", @project.id %>
    <%= f.select "organization_id", nested_set_options(Organization) { |i| i.fullname }, 
                 { :disabled => @project.organizations.map(&:id), :include_blank => true,
                   :label => :field_parent_organization },
                 { :class => "orga-select2" } %>
    <%= submit_tag l(:button_add) %>
  </p>
<% end -%>

<% organizations = Organization.joins(:users => :members).where("project_id = ?", @project.id).uniq %>
<% organizations = organizations | Organization.joins(:memberships).where("project_id = ?", @project.id).uniq %>
<% if organizations.any? %>
<table class="list organizations">
  <thead><tr>
    <th class="organization"><%= l(:label_organization) %></th>
    <th class="role"><%= l(:label_role_plural) %></th>
    <th class="members"><%= l(:label_user_plural) %></th>
    <th class="buttons"> </th>
  </tr></thead>
  <tbody>
  <% organizations.sort_by do |o|
       "#{o.try(:fullname)}"
     end.each do |o| %>
    <tr id="orga-<%= o.id %>">
      <%= render :partial => 'projects/settings/members_organization', :locals => {:o => o, :roles => roles} %>
    </tr>
  <% end %>
  </tbody>
</table>
<% end %>

</div>
